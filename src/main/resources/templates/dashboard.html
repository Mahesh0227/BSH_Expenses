<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BSH EXPENSES ‚Äî Dashboard (Tabs)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --brand-blue: #2f8afc;
      --brand-blue-600: #2878e6;
      --muted: #6b7280;
      --card-bg: #ffffff;
      --soft-shadow: 0 8px 30px rgba(16,24,40,0.06);
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --accent-rose: #fca5a5;
      --accent-sky: #bfdbfe;
    }
    body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #f6f9fb; }
    .card { background: var(--card-bg); border-radius: 10px; box-shadow: var(--soft-shadow); border: 1px solid rgba(15,23,42,0.04); }
    input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 6px rgba(47,138,252,0.06); border-color: var(--brand-blue-600); }
    .kpi-icon { width:40px; height:40px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; }
    .sidebar-link.active { background: linear-gradient(180deg, rgba(47,138,252,0.10), rgba(47,138,252,0.06)); color: var(--brand-blue); box-shadow: inset 0 2px 0 rgba(255,255,255,0.6); border-radius: 8px; }
    .sidebar-link svg { display:block; }

    .action-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 1px solid rgba(99,102,241,0.08);
      background: #fff;
      box-shadow: 0 1px 0 rgba(16,24,40,0.02);
      cursor: pointer;
      transition: background .12s, transform .06s;
      padding: 0;
    }
    .action-btn:hover { background: rgba(47,138,252,0.06); transform: translateY(-1px); }
    .action-btn.delete { border-color: rgba(239,68,68,0.08); }
    .action-btn.delete:hover { background: rgba(239,68,68,0.06); }
    .action-btn svg { width: 16px; height: 16px; display: block; }
  </style>
</head>
<body class="min-h-screen">

  <div class="max-w-[1400px] mx-auto px-6 py-8">

    <div class="flex gap-6">
      <!-- SIDEBAR -->
      <aside class="w-[300px] flex-shrink-0">
        <div class="card p-5 mb-5">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#58a4ff] to-var(--brand-blue) flex items-center justify-center text-white shadow">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" class="">
                <path d="M3 17h3v4H3v-4zM9 11h3v10H9V11zM15 5h3v16h-3V5z" fill="white"/>
              </svg>
            </div>
            <div>
              <div class="text-lg font-semibold text-[#2f8afc]">BSH EXPENSES</div>
              <div class="text-xs text-muted text-slate-500">Financial Management System</div>
            </div>
          </div>

          <div class="border-t pt-4">
            <div class="text-sm font-medium text-slate-700 mb-2">Filter Data</div>
            <label class="block text-xs text-slate-600 mb-2">Year</label>
            <select id="filterYear" class="w-full px-3 py-2 rounded-md border border-gray-200 text-sm mb-3">
              <option>2027</option>
              <option>2026</option>
              <option>2025</option>
              <option>2024</option>
              <option>2023</option>
              <option>2022</option>
              <option>2021</option>
              <option>2020</option>
            </select>

            <label class="block text-xs text-slate-600 mb-2">Month</label>
            <select id="filterMonth" class="w-full px-3 py-2 rounded-md border border-gray-200 text-sm mb-3">
              <option>All Months</option>
              <option>January</option>
              <option>February</option>
              <option>March</option>
              <option>April</option>
              <option>May</option>
              <option>June</option>
              <option>July</option>
              <option>August</option>
              <option>September</option>
              <option>October</option>
              <option>November</option>
              <option>December</option>
            </select>
          </div>
        </div>

        <nav class="card p-4 space-y-2">
          <div class="text-sm font-semibold text-slate-600 mb-3">Sections</div>
          <ul class="space-y-2">
            <li>
              <a href="#" data-tab="income" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md bg-[#e9f4ff] text-[#2f8afc]">
                <span class="w-8 h-8 rounded-md bg-white/60 flex items-center justify-center">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 17h3v4H3v-4zM9 11h3v10H9V11zM15 5h3v16h-3V5z" fill="#2f8afc"/></svg>
                </span>
                <span class="font-medium">Income</span>
              </a>
            </li>

            <li>
              <a href="#" data-tab="expenses" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-slate-50">
                <span class="w-8 h-8 rounded-md bg-white/60 flex items-center justify-center">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2v20M5 12h14" stroke="#ef4444" stroke-width="1.6" stroke-linecap="round"/></svg>
                </span>
                <span class="text-slate-700">Expenses</span>
              </a>
            </li>

            <li>
              <a href="#" data-tab="savings" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-slate-50">
                <span class="w-8 h-8 rounded-md bg-white/60 flex items-center justify-center">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="#3b82f6" stroke-width="1.4"/></svg>
                </span>
                <span class="text-slate-700">Savings</span>
              </a>
            </li>

            <li>
              <a href="#" data-tab="reports" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-slate-50">
                <span class="w-8 h-8 rounded-md bg-white/60 flex items-center justify-center">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M3 6h18M3 12h18M3 18h18" stroke="#64748b" stroke-width="1.2"/></svg>
                </span>
                <span class="text-slate-700">Reports</span>
              </a>
            </li>

            <li>
              <a href="#" data-tab="download" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-slate-50">
                <span class="w-8 h-8 rounded-md bg-white/60 flex items-center justify-center">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 3v12M7 10l5 5 5-5" stroke="#64748b" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </span>
                <span class="text-slate-700">Download Data</span>
              </a>
            </li>

            <li>
              <a href="#" data-tab="upload" class="sidebar-link flex items-center gap-3 px-3 py-2 rounded-md hover:bg-slate-50">
                <span class="w-8 h-8 rounded-md bg-white/60 flex items-center justify-center">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 21V9M7 14l5-5 5 5" stroke="#64748b" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </span>
                <span class="text-slate-700">Upload Data</span>
              </a>
            </li>
          </ul>
        </nav>

        <div class="mt-4 text-xs text-slate-500">
          <div class="card p-3 text-center">
            <div class="text-slate-700 font-medium">Welcome back!</div>
            <div class="text-slate-400">Track your finances professionally.</div>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="flex-1">
        <!-- top header -->
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-4">
            <h2 class="text-2xl font-semibold text-slate-800">Dashboard</h2>
            <p class="text-sm text-slate-500">Welcome back! Track your finances professionally.</p>
          </div>

          <div class="flex items-center gap-4">
            <button id="logoutBtn"
  class="px-4 py-2 rounded-md bg-white border border-gray-200 shadow-sm
         flex items-center gap-2 hover:bg-slate-50">
  Logout
</button>

          </div>
        </div>

        <!-- KPI cards (always present) -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <!-- Income -->
          <div class="card p-4 flex items-start gap-3">
            <div class="kpi-icon bg-[#e7f8ef] border border-white/60">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2l7 3v5c0 5-3.7 9.8-7 11-3.3-1.2-7-6-7-11V5l7-3z" fill="#10b981"/></svg>
            </div>
            <div class="flex-1">
              <div class="text-sm text-slate-500">Monthly Income Total</div>
              <div id="kpiIncome" class="text-2xl font-bold text-emerald-600 mt-1">‚Çπ0.00</div>
              <div class="text-xs text-slate-400 mt-1">Total income this period</div>
            </div>
          </div>

          <!-- Expenses -->
          <div class="card p-4 flex items-start gap-3">
            <div class="kpi-icon bg-[#fff1f2]">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2v6" stroke="#ef4444" stroke-width="1.6" stroke-linecap="round"/></svg>
            </div>
            <div class="flex-1">
              <div class="text-sm text-slate-500">Monthly Expenses Total</div>
              <div id="kpiExpenses" class="text-2xl font-bold text-rose-600 mt-1">‚Çπ0.00</div>
              <div class="text-xs text-slate-400 mt-1">Total expenses this period</div>
            </div>
          </div>

          <!-- Savings -->
          <div class="card p-4 flex items-start gap-3">
            <div class="kpi-icon bg-[#eef6ff]">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2l7 3v5c0 5-3.7 9.8-7 11-3.3-1.2-7-6-7-11V5l7-3z" fill="#3b82f6"/></svg>
            </div>
            <div class="flex-1">
              <div class="text-sm text-slate-500">Monthly Savings Total</div>
              <div id="kpiSavings" class="text-2xl font-bold text-sky-600 mt-1">‚Çπ0.00</div>
              <div class="text-xs text-slate-400 mt-1">Total savings this period</div>
            </div>
          </div>

          <!-- In Account -->
          <div class="card p-4 flex items-start gap-3">
            <div class="kpi-icon bg-[#eaf6ff]">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 2l7 3v5c0 5-3.7 9.8-7 11-3.3-1.2-7-6-7-11V5l7-3z" fill="#0ea5a5"/></svg>
            </div>
            <div class="flex-1">
              <div class="text-sm text-slate-500">In Account</div>
              <div id="kpiBalance" class="text-2xl font-bold text-emerald-600 mt-1">‚Çπ0.00</div>
              <div class="text-xs text-slate-400 mt-1">Available balance</div>
            </div>
          </div>
        </div>

        <!-- MAIN TAB CONTENT AREA -->
        <div id="tabContainer">

          <!-- INCOME (default) -->
          <section data-panel="income" class="tab-panel">
            <div class="card p-5 mb-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">Add Income</h3>
                <div class="text-sm text-slate-500">Income - <span id="currentMonthIncome">December 2025</span></div>
              </div>

              <form id="addIncomeForm" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
                <div class="md:col-span-5">
                  <label class="text-xs font-medium text-slate-600">Source</label>
                  <input id="source" type="text" placeholder="e.g., Salary, Freelance" class="w-full mt-2 px-3 py-2 rounded-md border border-gray-200 text-sm" />
                </div>

                <div class="md:col-span-3">
                  <label class="text-xs font-medium text-slate-600">Date</label>
                  <input id="date" type="date" class="w-full mt-2 px-3 py-2 rounded-md border border-gray-200 text-sm" />
                </div>

                <div class="md:col-span-2">
                  <label class="text-xs font-medium text-slate-600">Amount (‚Çπ)</label>
                  <input id="amount" type="number" step="0.01" class="w-full mt-2 px-3 py-2 rounded-md border border-gray-200 text-sm" placeholder="0.00" />
                </div>

                <div class="md:col-span-2">
                  <label class="block text-xs text-transparent">Add</label>
                  <button type="submit" class="w-full mt-2 px-4 py-2 rounded-md bg-[#2f8afc] hover:bg-[#2878e6] text-white font-semibold">Add Income</button>
                </div>
              </form>
            </div>

            <div class="card p-5">
              <div class="mb-4 flex items-center justify-between">
                <h4 class="text-green-600 font-semibold">Income - <span id="incomePeriodLabel">Period</span></h4>
                <div id="incomeEmptyHint" class="text-sm text-slate-400">No income records for this period</div>
              </div>

              <div class="overflow-x-auto">
                <table class="min-w-full text-sm divide-y">
                  <thead class="text-slate-500">
                    <tr>
                      <th class="text-left py-3 px-4">Source</th>
                      <th class="text-left py-3 px-4">Date</th>
                      <th class="text-left py-3 px-4">Amount</th>
                      <th class="text-left py-3 px-4">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="incomeTbody" class="bg-white divide-y">
                    <tr>
                      <td colspan="4" class="py-8 text-center text-slate-400">No income records for this period</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- EXPENSES -->
          <section data-panel="expenses" class="tab-panel hidden">
            <div class="card p-5 mb-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">Add Expense</h3>
                <div class="text-sm text-slate-500">Expenses - <span id="currentMonthExpenses">December 2025</span></div>
              </div>

              <form id="addExpenseForm" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
                <div class="md:col-span-6">
                  <label class="text-xs font-medium text-slate-600">Expense Details</label>
                  <input id="expenseDetails" type="text" placeholder="e.g., Groceries, Rent, Utilities" class="w-full mt-2 px-3 py-2 rounded-md border border-gray-200 text-sm" />
                </div>

                <div class="md:col-span-3">
                  <label class="text-xs font-medium text-slate-600">Date</label>
                  <input id="expenseDate" type="date" class="w-full mt-2 px-3 py-2 rounded-md border border-gray-200 text-sm" />
                </div>

                <div class="md:col-span-3">
                  <label class="text-xs font-medium text-slate-600">Amount (‚Çπ)</label>
                  <input id="expenseAmount" type="number" step="0.01" class="w-full mt-2 px-3 py-2 rounded-md border border-gray-200 text-sm" placeholder="0.00" />
                </div>

                <div class="md:col-span-6">
                  <label class="text-xs font-medium text-slate-600">Payment Mode</label>
                  <select id="expensePaymentMode" class="w-full mt-2 px-3 py-2 rounded-md border border-gray-200 text-sm">
                    <option value="">Select payment mode</option>
                    <option>Cash</option>
                    <option>Card</option>
                    <option>UPI</option>
                  </select>
                </div>

                <div class="md:col-span-3">
                  <label class="text-xs font-medium text-slate-600">Bill Attachment</label>
                  <input id="expenseBill" type="file" class="w-full mt-2 text-sm" />
                </div>

                <div class="md:col-span-3">
                  <label class="text-xs font-medium text-slate-600">Warranty Card</label>
                  <input id="expenseWarranty" type="file" class="w-full mt-2 text-sm" />
                </div>

                <div class="md:col-span-12">
                  <button type="submit" class="w-full mt-2 px-4 py-2 rounded-md bg-[#2f8afc] hover:bg-[#2878e6] text-white font-semibold">Add Expense</button>
                </div>
              </form>
            </div>

            <div class="card p-5">
             <div class="mb-4 flex items-center justify-between">
  <h4 class="text-rose-600 font-semibold">
    Expenses - <span id="expensesPeriodLabel">Period</span>
  </h4>

  <!-- RIGHT SIDE SEARCH + TOTAL -->
  <div class="flex items-center gap-3">
    <!-- Search -->
    <div class="relative">
      <input
        id="expenseSearch"
        type="text"
        placeholder="Search expenses..."
        class="pl-9 pr-3 py-2 text-sm border border-gray-200 rounded-md focus:border-[#2f8afc]"
      />
      <svg class="absolute left-3 top-2.5" width="14" height="14" viewBox="0 0 24 24" fill="none">
        <circle cx="11" cy="11" r="7" stroke="#6b7280" stroke-width="1.5"/>
        <path d="M20 20L17 17" stroke="#6b7280" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
    </div>

    <!-- Total -->
    <div class="px-3 py-2 rounded-md border border-red-200 bg-red-50 text-sm font-semibold text-red-600">
      Total: ‚Çπ<span id="expenseSearchTotal">0.00</span>
    </div>
  </div>
</div>


              <div class="overflow-x-auto">
                <table class="min-w-full text-sm divide-y">
                  <thead class="text-slate-500">
                    <tr>
                      <th class="text-left py-3 px-4">Expense Details</th>
                      <th class="text-left py-3 px-4">Date</th>
                      <th class="text-left py-3 px-4">Payment Mode</th>
                      <th class="text-left py-3 px-4">Amount</th>
                      <th class="text-left py-3 px-4">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="expensesTbody" class="bg-white divide-y">
                    <tr>
                      <td colspan="5" class="py-8 text-center text-slate-400">No expenses records for this period</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- SAVINGS -->
          <section data-panel="savings" class="tab-panel hidden">
            <div class="card p-5 mb-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-slate-800">Add Savings</h3>
                <div class="text-sm text-slate-500">Savings - <span id="currentMonthSavings">December 2025</span></div>
              </div>

              <form id="addSavingForm" class="grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
                <div class="md:col-span-4">
                  <label class="text-xs font-medium text-slate-600">Date</label>
                  <input id="savingDate" type="date" class="w-full mt-2 px-3 py-2 rounded-md border border-gray-200 text-sm" />
                </div>

                <div class="md:col-span-6">
                  <label class="text-xs font-medium text-slate-600">Saving Details</label>
                  <input id="savingDetails" type="text" placeholder="Enter saving details" class="w-full mt-2 px-3 py-2 rounded-md border border-gray-200 text-sm" />
                </div>

                <div class="md:col-span-2">
                  <label class="text-xs font-medium text-slate-600">Amount (‚Çπ)</label>
                  <input id="savingAmount" type="number" step="0.01" class="w-full mt-2 px-3 py-2 rounded-md border border-gray-200 text-sm" placeholder="0.00" />
                </div>

                <div class="md:col-span-12">
                  <button type="submit" class="w-full mt-2 px-4 py-2 rounded-md bg-[#2f8afc] hover:bg-[#2878e6] text-white font-semibold">Add Savings</button>
                </div>
              </form>
            </div>

            <div class="card p-5">
              <div class="mb-4 flex items-center justify-between">
                <h4 class="text-blue-600 font-semibold">Savings - December 2025</h4>
                <div class="text-sm text-slate-400">No savings records for this period</div>
              </div>

              <div class="overflow-x-auto">
                <table class="min-w-full text-sm divide-y">
                  <thead class="text-slate-500">
                    <tr>
                      <th class="text-left py-3 px-4">Saving Details</th>
                      <th class="text-left py-3 px-4">Date</th>
                      <th class="text-left py-3 px-4">Amount</th>
                      <th class="text-left py-3 px-4">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="savingsTbody" class="bg-white divide-y">
                    <tr>
                      <td colspan="4" class="py-8 text-center text-slate-400">No savings records for this period</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- REPORTS (kept minimal) -->
         <!-- REPORTS -->
<section data-panel="reports" class="tab-panel hidden">
  <div class="card p-5 mb-6">
    <h3 class="text-lg font-semibold text-slate-800 mb-4">
      Reports ‚Äî <span class="text-slate-500">2025</span>
    </h3>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

      <!-- Monthly Overview -->
      <div class="card p-5">
        <h4 class="font-semibold text-slate-700 mb-3">
          Monthly Overview - 2025
        </h4>
        <canvas id="monthlyOverviewChart" height="260"></canvas>
      </div>

      <!-- Net Amount Trend -->
      <div class="card p-5">
        <h4 class="font-semibold text-slate-700 mb-3">
          Net Amount Trend - 2025
        </h4>
        <canvas id="netTrendChart" height="260"></canvas>
      </div>

    </div>
  </div>
</section>
<section data-panel="download" class="tab-panel hidden">
  <div class="card p-5">
    <h3 class="text-lg font-semibold text-slate-800 mb-1">
      Download Financial Data
    </h3>
    <p class="text-sm text-slate-500 mb-5">
      Export your income, expenses, and savings data to Excel
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="text-xs text-slate-600">Year</label>
        <select id="downloadYear"
          class="w-full mt-2 px-3 py-2 border rounded-md text-sm">
        </select>
      </div>

      <div>
        <label class="text-xs text-slate-600">Month</label>
        <select id="downloadMonth"
          class="w-full mt-2 px-3 py-2 border rounded-md text-sm">
          <option value="ALL">All Months (Yearly)</option>
          <option>January</option>
          <option>February</option>
          <option>March</option>
          <option>April</option>
          <option>May</option>
          <option>June</option>
          <option>July</option>
          <option>August</option>
          <option>September</option>
          <option>October</option>
          <option>November</option>
          <option>December</option>
        </select>
      </div>
    </div>

    <button id="downloadExcelBtn"
      class="px-4 py-2 bg-[#2f8afc] hover:bg-[#2878e6] text-white rounded-md text-sm font-semibold flex items-center gap-2">
      ‚¨á Download Excel
    </button>
  </div>
</section>
<section data-panel="upload" class="tab-panel hidden">

  <!-- UPLOAD CARD -->
  <div class="card p-6 max-w-3xl">

    <div class="flex items-center gap-3 mb-2">
      <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
        ‚¨ÜÔ∏è
      </div>
      <h3 class="text-lg font-semibold text-slate-800">
        Upload Financial Data
      </h3>
    </div>

    <p class="text-sm text-slate-500 mb-4">
      Upload your existing financial data from an Excel file
    </p>

    <!-- DOWNLOAD TEMPLATE -->
    <button onclick="downloadTemplate()"
      class="inline-flex items-center gap-2 px-4 py-2 mb-5 rounded-md
             border border-gray-200 bg-white text-sm font-medium
             hover:bg-slate-50">
      ‚¨á Download Template
    </button>

    <!-- FILE INPUT -->
    <div class="border-2 border-dashed border-blue-300 rounded-lg p-4
                flex items-center justify-between bg-blue-50">

      <div class="flex items-center gap-3 text-sm text-slate-600">
        üìÑ <span id="selectedFileName">No file chosen</span>
      </div>

      <label
        class="cursor-pointer px-4 py-2 rounded-md
               bg-white border border-blue-300
               text-blue-600 font-semibold text-sm
               hover:bg-blue-100">
        Choose File
        <input id="excelFileInput" type="file" accept=".xlsx,.xls" class="hidden" />
      </label>
    </div>

    <p class="text-xs text-slate-400 mt-2">
      Accepted formats: .xlsx, .xls
    </p>

    <!-- UPLOAD BUTTON -->
    <button id="uploadExcelBtn"
      class="mt-4 px-4 py-2 bg-[#2f8afc] hover:bg-[#2878e6]
             text-white rounded-md text-sm font-semibold">
      Upload Excel
    </button>

    <!-- UPLOAD MESSAGE -->
    <div id="uploadMsg"
      class="hidden mt-3 px-4 py-2 rounded-md text-sm font-medium">
    </div>

  </div>
</section>



        </div>
        <!-- end tabContainer -->
      </main>
    </div>
  </div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

 <script>
  document.addEventListener('DOMContentLoaded', () => {
    // ---------- Utilities ----------
    const monthNames = [ "January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December" ];

    function escapeHtml(s) {
      if (s == null) return '';
      return String(s).replace(/[&<>"']/g, function(m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
      });
    }
    function escapeAttr(s) {
      if (s == null) return '';
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }
    const parseCurrency = (str) => Number(String(str).replace(/[^\d\.-]/g,'') || 0);

    // Global totals (based on filtered results)
    let totalIncome = 0, totalExpenses = 0, totalSavings = 0;

    // ---------- UI: tabs/sidebar ----------
    const sidebarLinks = document.querySelectorAll('.sidebar-link');
    const panels = document.querySelectorAll('[data-panel]');
    const setActive = (tab) => {
      panels.forEach(p => p.getAttribute('data-panel') === tab ? p.classList.remove('hidden') : p.classList.add('hidden'));
      sidebarLinks.forEach(a => a.dataset.tab === tab ? a.classList.add('active') : a.classList.remove('active'));
    };
    setActive('income');
    sidebarLinks.forEach(a => a.addEventListener('click', (e) => { e.preventDefault(); setActive(a.dataset.tab); }));

    // ---------- set today's date on inputs ----------
    const todayISO = new Date().toISOString().substring(0,10);
    ['date','expenseDate','savingDate'].forEach(id => { const el = document.getElementById(id); if (el) el.value = todayISO; });

    // ---------- show current month labels ----------
    const d = new Date();
    const currentLabel = `${monthNames[d.getMonth()]} ${d.getFullYear()}`;
    document.getElementById('currentMonthIncome').innerText = currentLabel;
    document.getElementById('currentMonthExpenses').innerText = currentLabel;
    document.getElementById('currentMonthSavings').innerText = currentLabel;

    // ---------- Filters defaults & change handling ----------
    (function initFilters() {
      const yearEl = document.getElementById('filterYear');
      const monthEl = document.getElementById('filterMonth');
      const currentYear = d.getFullYear();
      const currentMonthName = monthNames[d.getMonth()];

      if (yearEl) {
        let found = false;
        Array.from(yearEl.options).forEach(opt => {
          if (String(opt.value) === String(currentYear) || opt.text === String(currentYear)) {
            opt.selected = true; found = true;
          }
        });
        if (!found) {
          const newOpt = document.createElement('option'); newOpt.value = currentYear; newOpt.text = currentYear; yearEl.appendChild(newOpt); newOpt.selected = true;
        }
      }
      if (monthEl) {
        let found = false;
        Array.from(monthEl.options).forEach(opt => {
          if (opt.value === currentMonthName || opt.text === currentMonthName) { opt.selected = true; found = true; }
        });
        if (!found) {
          const newOpt = document.createElement('option'); newOpt.value = currentMonthName; newOpt.text = currentMonthName; monthEl.appendChild(newOpt); newOpt.selected = true;
        }
      }

      const onFilterChange = async () => {
        await Promise.allSettled([ loadIncomes(), loadExpenses(), loadSavings() ]);
        updateKPIs();
      };
      yearEl && yearEl.addEventListener('change', onFilterChange);
      monthEl && monthEl.addEventListener('change', onFilterChange);
    })();

    // ---------- KPI updater ----------
    function updateKPIs() {
      document.getElementById('kpiIncome').innerText = `‚Çπ${Number(totalIncome || 0).toFixed(2)}`;
      document.getElementById('kpiExpenses').innerText = `‚Çπ${Number(totalExpenses || 0).toFixed(2)}`;
      document.getElementById('kpiSavings').innerText = `‚Çπ${Number(totalSavings || 0).toFixed(2)}`;
      const balance = (Number(totalIncome || 0) - Number(totalExpenses || 0) - Number(totalSavings || 0));
      document.getElementById('kpiBalance').innerText = `‚Çπ${Number(balance || 0).toFixed(2)}`;
    }

    // ---------- Helper: read selected filters ----------
    function readFilters() {
      const yearSelect = document.getElementById('filterYear');
      const monthSelect = document.getElementById('filterMonth');
      const selectedYear = yearSelect ? (yearSelect.value ? Number(yearSelect.value) : null) : null;
      const selectedMonthName = monthSelect ? (monthSelect.value || 'All Months') : 'All Months';
      return { selectedYear, selectedMonthName };
    }

    function dateToParts(dVal) {
      const d = new Date(dVal);
      if (isNaN(d)) return { year: null, monthName: null };
      return { year: d.getFullYear(), monthName: monthNames[d.getMonth()] };
    }

    // ---------- Incomes: load, add, edit, delete ----------
    async function loadIncomes() {
      const tbody = document.getElementById('incomeTbody');
      const emptyHint = document.getElementById('incomeEmptyHint');
      const periodLabel = document.getElementById('incomePeriodLabel');
      if (!tbody) return;
      tbody.innerHTML = `<tr><td colspan="4" class="py-6 text-center text-slate-500">Loading...</td></tr>`;
      try {
        const resp = await fetch('/api/incomes');
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const incomes = await resp.json();

        const { selectedYear, selectedMonthName } = readFilters();

        if (!Array.isArray(incomes) || incomes.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="py-6 text-center text-slate-400">No income records found</td></tr>`;
          emptyHint && (emptyHint.style.display = "block");
          totalIncome = 0;
          updateKPIs();
          periodLabel && (periodLabel.innerText = selectedMonthName === 'All Months' ? (selectedYear || 'All Years') : `${selectedMonthName} ${selectedYear || ''}`);
          return;
        }

        const filtered = incomes.filter(i => {
          const { year, monthName } = dateToParts(i.date || i.createdAt || i.created_at);
          if (year === null) return false;
          if (selectedYear && year !== selectedYear) return false;
          if (!selectedMonthName || selectedMonthName === 'All Months') return true;
          return monthName === selectedMonthName;
        });

        if (filtered.length === 0) {
          tbody.innerHTML = `<tr><td colspan="4" class="py-6 text-center text-slate-400">No income records for this period</td></tr>`;
          emptyHint && (emptyHint.style.display = "block");
          totalIncome = 0;
          updateKPIs();
          periodLabel && (periodLabel.innerText = selectedMonthName === 'All Months' ? (selectedYear || 'All Years') : `${selectedMonthName} ${selectedYear || ''}`);
          return;
        }

        emptyHint && (emptyHint.style.display = "none");
        filtered.sort((a,b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt));
        totalIncome = 0;
        tbody.innerHTML = filtered.map(i => {
          const d = new Date(i.date);
          const dd = isNaN(d) ? '' : String(d.getDate()).padStart(2,'0');
          const mm = isNaN(d) ? '' : String(d.getMonth()+1).padStart(2,'0');
          const yyyy = isNaN(d) ? '' : d.getFullYear();
          const amt = Number(i.amount || 0);
          totalIncome += amt;
          return `
            <tr data-id="${i.id}">
              <td class="py-3 px-4 source-cell">${escapeHtml(i.source || '')}</td>
              <td class="py-3 px-4 date-cell">${dd ? dd + '-' + mm + '-' + yyyy : ''}</td>
              <td class="py-3 px-4 text-center amount-cell">‚Çπ${amt.toFixed(2)}</td>
              <td class="py-3 px-4 text-center actions-cell">
                <button title="Edit" class="edit-income action-btn" data-id="${i.id}" aria-label="Edit">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><rect x="3.5" y="3.5" width="17" height="17" rx="5" stroke="#6b7280" stroke-width="1.8"/><path d="M15.5 8.5L17.5 10.5L13 15H11V13L15.5 8.5Z" stroke="#6b7280" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button title="Delete" class="delete-income action-btn delete ml-2" data-id="${i.id}" aria-label="Delete">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 7H20" stroke="#ef4444" stroke-width="1.8" stroke-linecap="round"/><path d="M10 11V17" stroke="#ef4444" stroke-width="1.8" stroke-linecap="round"/><path d="M14 11V17" stroke="#ef4444" stroke-width="1.8" stroke-linecap="round"/></svg>
                </button>
              </td>
            </tr>
          `;
        }).join('');

        periodLabel && (periodLabel.innerText = selectedMonthName === 'All Months' ? (selectedYear || 'All Years') : `${selectedMonthName} ${selectedYear || ''}`);
        updateKPIs();
      } catch (err) {
        console.error('loadIncomes error', err);
        tbody.innerHTML = `<tr><td colspan="4" class="py-6 text-center text-red-600">Error loading incomes</td></tr>`;
        totalIncome = 0;
        updateKPIs();
      }
    }

    // Add Income
    (function attachAddIncome() {
      const addIncomeForm = document.getElementById('addIncomeForm');
      if (!addIncomeForm) return;
      addIncomeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const src = document.getElementById('source').value.trim();
        const date = document.getElementById('date').value;
        const amount = parseFloat(document.getElementById('amount').value || 0);
        if (!src || !date || !amount || amount <= 0) { alert('Please fill: source, date and amount (amount > 0).'); return; }
        const payload = { userId: 1, source: src, date, amount }; // replace userId if using auth
        try {
          const resp = await fetch('/api/incomes', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if (!resp.ok) { const txt = await resp.text().catch(()=> ''); alert('Save failed: ' + (txt || 'HTTP ' + resp.status)); return; }
          addIncomeForm.reset(); document.getElementById('date').value = todayISO;
          await loadIncomes();
        } catch (err) {
          console.error('add income error', err); alert('Failed to save income: ' + (err.message || err));
        }
      });
    })();

    // Incomes: edit / save / cancel / delete (delegated)
    document.addEventListener('click', async (e) => {
      // Delete income
      const del = e.target.closest && e.target.closest('.delete-income');
      if (del) {
        const id = del.dataset.id;
        if (!id) return;
        if (!confirm('Are you sure you want to delete this income record?')) return;
        try {
          const resp = await fetch(`/api/incomes/${id}`, { method: 'DELETE' });
          if (resp.ok) await loadIncomes(); else { const txt = await resp.text().catch(()=> ''); alert('Delete failed: ' + (txt || 'HTTP ' + resp.status)); }
        } catch (err) { console.error('delete income', err); alert('Delete failed: ' + (err.message || err)); }
        return;
      }

      // Enter edit mode
      const editBtn = e.target.closest && e.target.closest('.edit-income');
      if (editBtn) {
        const tr = editBtn.closest('tr'); if (!tr) return;
        const id = tr.dataset.id;
        const sourceCell = tr.querySelector('.source-cell');
        const dateCell = tr.querySelector('.date-cell');
        const amountCell = tr.querySelector('.amount-cell');
        const actionsCell = tr.querySelector('.actions-cell');

        const currentSource = sourceCell ? sourceCell.innerText.trim() : '';
        const dateParts = (dateCell ? dateCell.innerText.trim() : '').split('-');
        let isoDate = ''; if (dateParts.length === 3) isoDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`; else isoDate = todayISO;
        const currentAmount = amountCell ? amountCell.innerText.replace(/[^\d\.\-]/g,'') : '0.00';

        sourceCell.innerHTML = `<input class="edit-source w-full px-2 py-1 rounded border border-gray-200 text-sm" value="${escapeAttr(currentSource)}" />`;
        dateCell.innerHTML = `<input type="date" class="edit-date w-full px-2 py-1 rounded border border-gray-200 text-sm" value="${isoDate}" />`;
        amountCell.innerHTML = `<input type="number" step="0.01" class="edit-amount w-full text-right px-2 py-1 rounded border border-gray-200 text-sm" value="${Number(currentAmount).toFixed(2)}" />`;

        actionsCell.innerHTML = `
          <button title="Save" class="save-income action-btn" data-id="${id}" aria-label="Save">
            <svg viewBox="0 0 24 24" fill="none"><path d="M5 13l4 4L19 7" stroke="#10b981" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button title="Cancel" class="cancel-income action-btn ml-2" aria-label="Cancel">
            <svg viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#6b7280" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
        `;
        return;
      }

      // Cancel income edit
      if (e.target.closest && e.target.closest('.cancel-income')) { await loadIncomes(); return; }

      // Save income edit
      if (e.target.closest && e.target.closest('.save-income')) {
        const btn = e.target.closest('.save-income');
        const id = btn.dataset.id; const tr = btn.closest('tr');
        const srcInput = tr.querySelector('.edit-source'); const dateInput = tr.querySelector('.edit-date'); const amtInput = tr.querySelector('.edit-amount');
        const newSource = srcInput ? srcInput.value.trim() : ''; const newDate = dateInput ? dateInput.value : ''; const newAmt = amtInput ? parseFloat(amtInput.value || 0) : 0;
        if (!newSource || !newDate || !newAmt || newAmt <= 0) { alert('Please fill: source, date and amount (amount > 0).'); return; }
        const payload = { id: Number(id), source: newSource, date: newDate, amount: newAmt };
        try {
          const resp = await fetch(`/api/incomes/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if (resp.ok) await loadIncomes(); else { const txt = await resp.text().catch(()=> ''); alert('Update failed: ' + (txt || 'HTTP ' + resp.status)); }
        } catch (err) { console.error('update income', err); alert('Update failed: ' + (err.message || err)); }
        return;
      }
    });

    // ---------- Expenses: load, add, edit, delete ----------
    async function loadExpenses() {
      const tbody = document.getElementById('expensesTbody');
      const periodLabel = document.getElementById('expensesPeriodLabel');
      if (!tbody) return;
      tbody.innerHTML = `<tr><td colspan="5" class="py-6 text-center text-slate-500">Loading...</td></tr>`;
      try {
        const resp = await fetch('/api/expenses');
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const expenses = await resp.json();

        const { selectedYear, selectedMonthName } = readFilters();

        if (!Array.isArray(expenses) || expenses.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="py-8 text-center text-slate-400">No expenses records for this period</td></tr>`;
          totalExpenses = 0; updateKPIs();
          periodLabel && (periodLabel.innerText = selectedMonthName === 'All Months' ? (selectedYear || 'All Years') : `${selectedMonthName} ${selectedYear || ''}`);
          return;
        }

        const filtered = expenses.filter(e => {
          const { year, monthName } = dateToParts(e.date || e.createdAt || e.created_at);
          if (year === null) return false;
          if (selectedYear && year !== selectedYear) return false;
          if (!selectedMonthName || selectedMonthName === 'All Months') return true;
          return monthName === selectedMonthName;
        });

        if (filtered.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="py-8 text-center text-slate-400">No expenses records for this period</td></tr>`;
          totalExpenses = 0; updateKPIs();
          periodLabel && (periodLabel.innerText = selectedMonthName === 'All Months' ? (selectedYear || 'All Years') : `${selectedMonthName} ${selectedYear || ''}`);
          return;
        }

        filtered.sort((a,b) => new Date(b.date || b.createdAt) - new Date(a.date || a.createdAt));
        totalExpenses = 0;
        tbody.innerHTML = filtered.map(e => {
          const d = new Date(e.date || e.createdAt || '');
          const dd = isNaN(d) ? '' : String(d.getDate()).padStart(2,'0');
          const mm = isNaN(d) ? '' : String(d.getMonth()+1).padStart(2,'0');
          const yyyy = isNaN(d) ? '' : d.getFullYear();
          const amt = Number(e.amount || 0);
          totalExpenses += amt;
          return `
            <tr data-id="${e.id}">
              <td class="py-3 px-4">${escapeHtml(e.expenseDetails || '')}</td>
              <td class="py-3 px-4">${dd ? dd + '-' + mm + '-' + yyyy : ''}</td>
              <td class="py-3 px-4">${escapeHtml(e.payment || '-')}</td>
              <td class="py-3 px-4 text-center">‚Çπ${amt.toFixed(2)}</td>
              <td class="py-3 px-4 text-center actions-cell">
                <button title="Edit" class="edit-expense action-btn" data-id="${e.id}" aria-label="Edit">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="3.5" y="3.5" width="17" height="17" rx="5" stroke="#6b7280" stroke-width="1.6"/><path d="M15.5 8.5L17.5 10.5L13 15H11V13L15.5 8.5Z" stroke="#6b7280" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                </button>
                <button title="Delete" class="delete-expense action-btn delete ml-2" data-id="${e.id}" aria-label="Delete">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 7H20" stroke="#ef4444" stroke-width="1.8" stroke-linecap="round"/><path d="M10 11V17" stroke="#ef4444" stroke-width="1.8" stroke-linecap="round"/><path d="M14 11V17" stroke="#ef4444" stroke-width="1.8" stroke-linecap="round"/></svg>
                </button>
              </td>
            </tr>
          `;
        }).join('');

        periodLabel && (periodLabel.innerText = selectedMonthName === 'All Months' ? (selectedYear || 'All Years') : `${selectedMonthName} ${selectedYear || ''}`);
        updateKPIs();
      } catch (err) {
        console.error('loadExpenses error', err);
        document.getElementById('expensesTbody').innerHTML = `<tr><td colspan="5" class="py-6 text-center text-red-600">Error loading expenses</td></tr>`;
        totalExpenses = 0; updateKPIs();
      }
    }

    // Try file upload (returns { attachmentUrl, warrantyUrl } or nulls)
    async function tryUploadFiles(attachmentFile, warrantyFile) {
      if (!attachmentFile && !warrantyFile) return { attachmentUrl: null, warrantyUrl: null };
      try {
        const fd = new FormData();
        if (attachmentFile) fd.append('attachment', attachmentFile);
        if (warrantyFile) fd.append('warranty', warrantyFile);
        const uploadResp = await fetch('/api/expenses/upload', { method: 'POST', body: fd });
        if (!uploadResp.ok) { console.warn('upload endpoint not available'); return { attachmentUrl: null, warrantyUrl: null }; }
        const json = await uploadResp.json();
        return { attachmentUrl: json.attachmentUrl || null, warrantyUrl: json.warrantyUrl || null };
      } catch (err) {
        console.warn('file upload failed', err);
        return { attachmentUrl: null, warrantyUrl: null };
      }
    }

    // Add Expense
    (function attachAddExpense() {
      const addExpenseForm = document.getElementById('addExpenseForm');
      if (!addExpenseForm) return;
      addExpenseForm.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const details = document.getElementById('expenseDetails').value.trim();
        const date = document.getElementById('expenseDate').value;
        const amt = parseFloat(document.getElementById('expenseAmount').value || 0);
        const mode = document.getElementById('expensePaymentMode').value || '';
        const attachmentInput = document.getElementById('expenseBill');
        const warrantyInput = document.getElementById('expenseWarranty');
        if (!details || !date || !amt || amt <= 0) { alert('Please fill expense details, date and amount (amount > 0).'); return; }

        const attachmentFile = attachmentInput && attachmentInput.files && attachmentInput.files[0];
        const warrantyFile = warrantyInput && warrantyInput.files && warrantyInput.files[0];
        const uploaded = await tryUploadFiles(attachmentFile, warrantyFile);

        const payload = { userId: 1, expenseDetails: details, date: date, payment: mode, amount: amt, attachmentUrl: uploaded.attachmentUrl, warrantyUrl: uploaded.warrantyUrl };
        try {
          const resp = await fetch('/api/expenses', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if (!resp.ok) { const txt = await resp.text().catch(()=> ''); alert('Save failed: ' + (txt || 'HTTP ' + resp.status)); return; }
          addExpenseForm.reset(); document.getElementById('expenseDate').value = todayISO;
          await loadExpenses();
        } catch (err) { console.error('add expense failed', err); alert('Failed to save expense: ' + (err.message || err)); }
      });
    })();

    // Expenses: edit/save/cancel/delete handled in shared delegated listener below

    // ---------- Savings local handler (kept simple) ----------
    // For now savings handled locally like before, but filter-aware (year/month)
 // ---------- SAVINGS: load, add, edit, delete (SERVER CONNECTED) ----------

 // Load Savings from backend
async function loadSavings() {
  const tbody = document.getElementById("savingsTbody");
  const year = document.getElementById("filterYear").value;
  const month = document.getElementById("filterMonth").value;

  tbody.innerHTML = `
    <tr>
      <td colspan="4" class="py-6 text-center text-slate-500">Loading...</td>
    </tr>
  `;

  try {
    const params = new URLSearchParams();
    if (year) params.append("year", year);
    if (month && month !== "All Months") params.append("monthName", month);

    const resp = await fetch(`/api/savings?${params.toString()}`);
    if (!resp.ok) throw new Error("HTTP " + resp.status);

    const list = await resp.json();

    if (!Array.isArray(list) || list.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="py-8 text-center text-slate-400">
            No savings records for this period
          </td>
        </tr>`;
      totalSavings = 0;
      updateKPIs();
      return;
    }

    totalSavings = 0;

    tbody.innerHTML = list.map(s => {
      totalSavings += Number(s.amount || 0);

      return `
        <tr data-id="${s.id}">
          <td class="py-3 px-4 details-cell">${escapeHtml(s.details)}</td>
          <td class="py-3 px-4 date-cell">
            ${s.date ? s.date.split("-").reverse().join("/") : ""}
          </td>
          <td class="py-3 px-4 amount-cell">‚Çπ${Number(s.amount).toFixed(2)}</td>
          <td class="py-3 px-4 text-center actions-cell">
            <button class="edit-saving action-btn" data-id="${s.id}">‚úèÔ∏è</button>
            <button class="delete-saving action-btn delete ml-2" data-id="${s.id}">üóë</button>
          </td>
        </tr>
      `;
    }).join("");

    updateKPIs();

  } catch (err) {
    console.error("loadSavings error", err);
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="py-6 text-center text-red-600">
          Failed to load savings
        </td>
      </tr>`;
    totalSavings = 0;
    updateKPIs();
  }
}


 // Add new saving
 (function attachAddSaving() {
	  const form = document.getElementById("addSavingForm");
	  if (!form) return;

	  form.addEventListener("submit", async (e) => {
	    e.preventDefault();

	    const date = document.getElementById("savingDate").value;
	    const details = document.getElementById("savingDetails").value.trim();
	    const amt = Number(document.getElementById("savingAmount").value || 0);

	    if (!details || !date || amt <= 0) {
	      return alert("Please fill all fields correctly");
	    }

	    const payload = {
	      userId: 1,
	      details: details,   // MUST MATCH BACKEND
	      date: date,
	      amount: amt
	    };

	    try {
	      const resp = await fetch("/api/savings", {
	        method: "POST",
	        headers: { "Content-Type": "application/json" },
	        body: JSON.stringify(payload)
	      });

	      if (!resp.ok) throw new Error("Save failed");

	      form.reset();
	      document.getElementById("savingDate").value = new Date().toISOString().substring(0, 10);

	      await loadSavings();
	    } catch (err) {
	      console.error(err);
	      alert("Failed to save saving entry");
	    }
	  });
	})();


 // Saving edit/delete operations
 // ---------- SAVINGS: edit / delete / save ----------
document.addEventListener("click", async (e) => {

  // DELETE SAVING
  const delBtn = e.target.closest(".delete-saving");
  if (delBtn) {
    const id = delBtn.dataset.id;
    if (!confirm("Delete this saving record?")) return;

    try {
      const resp = await fetch(`/api/savings/${id}`, { method: "DELETE" });
      if (!resp.ok) throw new Error();
      await loadSavings();
    } catch {
      alert("Delete failed");
    }
    return;
  }

  // ENTER EDIT MODE
  const editBtn = e.target.closest(".edit-saving");
  if (editBtn) {
    const tr = editBtn.closest("tr");
    const id = tr.dataset.id;

    const detailsCell = tr.querySelector(".details-cell");
    const dateCell = tr.querySelector(".date-cell");
    const amountCell = tr.querySelector(".amount-cell");
    const actionCell = tr.querySelector(".actions-cell");

    const oldDetails = detailsCell.innerText.trim();
    const oldAmount = amountCell.innerText.replace(/[^\d.]/g, "");

    // üî• SAFE DATE PARSE
    const d = new Date(dateCell.innerText);
    const isoDate = isNaN(d)
      ? new Date().toISOString().substring(0, 10)
      : d.toISOString().substring(0, 10);

    detailsCell.innerHTML =
      `<input class="edit-details w-full border rounded px-2 py-1 text-sm" value="${escapeAttr(oldDetails)}"/>`;

    dateCell.innerHTML =
      `<input type="date" class="edit-date w-full border rounded px-2 py-1 text-sm" value="${isoDate}"/>`;

    amountCell.innerHTML =
      `<input type="number" step="0.01" class="edit-amount w-full text-right border rounded px-2 py-1 text-sm" value="${Number(oldAmount).toFixed(2)}"/>`;

    actionCell.innerHTML = `
      <button class="save-saving action-btn" data-id="${id}" title="Save">‚úî</button>
      <button class="cancel-saving action-btn ml-2" title="Cancel">‚úñ</button>
    `;
    return;
  }

  // CANCEL EDIT
  if (e.target.closest(".cancel-saving")) {
    await loadSavings();
    return;
  }

  // SAVE EDIT
  const saveBtn = e.target.closest(".save-saving");
  if (saveBtn) {
    const id = saveBtn.dataset.id;
    const tr = saveBtn.closest("tr");

    const details = tr.querySelector(".edit-details").value.trim();
    const date = tr.querySelector(".edit-date").value;
    const amount = Number(tr.querySelector(".edit-amount").value || 0);

    if (!details || !date || amount <= 0) {
      alert("Enter valid values");
      return;
    }

    const payload = { id, userId: 1, details, date, amount };

    try {
      const resp = await fetch(`/api/savings/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) throw new Error();
      await loadSavings();
    } catch {
      alert("Failed to update saving entry");
    }
  }
});


 // --- END SAVINGS SECTION ---

    // ---------- Delegated event listener for edits/deletes (expenses + incomes + savings) ----------
    document.addEventListener('click', async (e) => {
      // --- Expenses delete ---
      const delExp = e.target.closest && e.target.closest('.delete-expense');
      if (delExp) {
        const id = delExp.dataset.id;
        if (!id) return;
        if (!confirm('Are you sure you want to delete this expense?')) return;
        try {
          const resp = await fetch(`/api/expenses/${id}`, { method: 'DELETE' });
          if (resp.ok) { await loadExpenses(); } else { const txt = await resp.text().catch(()=> ''); alert('Delete failed: ' + (txt || 'HTTP ' + resp.status)); }
        } catch (err) { console.error('delete expense', err); alert('Delete failed: ' + (err.message || err)); }
        return;
      }

      // --- Enter expense edit ---
      const editExp = e.target.closest && e.target.closest('.edit-expense');
      if (editExp) {
        const tr = editExp.closest('tr'); if (!tr) return;
        const id = tr.dataset.id;
        const detailsCell = tr.cells[0], dateCell = tr.cells[1], paymentCell = tr.cells[2], amountCell = tr.cells[3], actionsCell = tr.cells[4];
        const currentDetails = detailsCell.innerText.trim();
        const dp = dateCell.innerText.trim().split('-'); let isoDate = ''; if (dp.length === 3) isoDate = `${dp[2]}-${dp[1]}-${dp[0]}`; else isoDate = todayISO;
        const currentPayment = paymentCell.innerText.trim() === '-' ? '' : paymentCell.innerText.trim();
        const currentAmount = amountCell.innerText.replace(/[^\d\.\-]/g,'') || '0.00';
        detailsCell.innerHTML = `<input class="edit-expense-details w-full px-2 py-1 rounded border border-gray-200 text-sm" value="${escapeAttr(currentDetails)}" />`;
        dateCell.innerHTML = `<input type="date" class="edit-expense-date w-full px-2 py-1 rounded border border-gray-200 text-sm" value="${isoDate}" />`;
        paymentCell.innerHTML = `<input class="edit-expense-payment w-full px-2 py-1 rounded border border-gray-200 text-sm" value="${escapeAttr(currentPayment)}" />`;
        amountCell.innerHTML = `<input type="number" step="0.01" class="edit-expense-amount w-full text-right px-2 py-1 rounded border border-gray-200 text-sm" value="${Number(currentAmount).toFixed(2)}" />`;
        actionsCell.innerHTML = `
          <button title="Save" class="save-expense action-btn" data-id="${id}" aria-label="Save"><svg viewBox="0 0 24 24" fill="none"><path d="M5 13l4 4L19 7" stroke="#10b981" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
          <button title="Cancel" class="cancel-expense action-btn ml-2" aria-label="Cancel"><svg viewBox="0 0 24 24" fill="none"><path d="M18 6L6 18M6 6l12 12" stroke="#6b7280" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
        `;
        return;
      }

      // --- Cancel expense edit ---
      if (e.target.closest && e.target.closest('.cancel-expense')) { await loadExpenses(); return; }

      // --- Save expense edit ---
      if (e.target.closest && e.target.closest('.save-expense')) {
        const btn = e.target.closest('.save-expense'); const id = btn.dataset.id; const tr = btn.closest('tr');
        const detailsInp = tr.querySelector('.edit-expense-details'); const dateInp = tr.querySelector('.edit-expense-date'); const payInp = tr.querySelector('.edit-expense-payment'); const amtInp = tr.querySelector('.edit-expense-amount');
        const newDetails = detailsInp ? detailsInp.value.trim() : ''; const newDate = dateInp ? dateInp.value : ''; const newPayment = payInp ? payInp.value.trim() : ''; const newAmt = amtInp ? parseFloat(amtInp.value || 0) : 0;
        if (!newDetails || !newDate || !newAmt || newAmt <= 0) { alert('Please fill expense details, date and amount (amount > 0).'); return; }
        const payload = { id: Number(id), expenseDetails: newDetails, date: newDate, payment: newPayment, amount: newAmt };
        try {
          const resp = await fetch(`/api/expenses/${id}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          if (resp.ok) await loadExpenses(); else { const txt = await resp.text().catch(()=> ''); alert('Update failed: ' + (txt || 'HTTP ' + resp.status)); }
        } catch (err) { console.error('update expense', err); alert('Update failed: ' + (err.message || err)); }
        return;
      }

      // --- Delete saving (local) ---
      if (e.target.matches('.delete-saving')) {
        const row = e.target.closest('tr');
        const idx = Array.from(row.parentElement.children).indexOf(row);
        // remove matching from savedSavings by index of filtered list; for simplicity reload by clearing all and re-rendering without this one
        // We'll locate by displayed text+amount+date match (simple)
        const details = row.cells[0].innerText.trim();
        const date = row.cells[1].innerText.trim();
        const amountText = row.cells[2].innerText.trim();
        const amountNum = parseCurrency(amountText);
        // find first matching and remove
        const foundIndex = savedSavings.findIndex(s => s.details === details && new Date(s.date).toLocaleDateString() === date && Number(s.amount) === amountNum);
        if (foundIndex !== -1) savedSavings.splice(foundIndex,1);
//=================================
      }
    });
 
    /* ===============================
    EXPENSE SEARCH + TOTAL
 ================================ */
    document.getElementById("expenseSearch").addEventListener("input", function () {
    	  const keyword = this.value.toLowerCase();
    	  const rows = document.querySelectorAll("#expensesTbody tr");

    	  let searchTotal = 0;
    	  let visibleCount = 0;

    	  rows.forEach(row => {
    	    const text = row.innerText.toLowerCase();

    	    if (text.includes(keyword)) {
    	      row.style.display = "";
    	      visibleCount++;

    	      const amountCell = row.querySelector("td:nth-child(4)");
    	      if (amountCell) {
    	        const amt = Number(amountCell.innerText.replace(/[^\d.]/g, ""));
    	        searchTotal += amt;
    	      }
    	    } else {
    	      row.style.display = "none";
    	    }
    	  });

    	  document.getElementById("expenseSearchTotal").innerText =
    	    searchTotal.toFixed(2);
    	});
    


    // ---------- Initial load ----------
    (async function initialLoad() {
      await Promise.allSettled([ loadIncomes(), loadExpenses(), loadSavings() ]);
      updateKPIs();
    })();

    // expose loaders if needed
    window.loadIncomes = loadIncomes;
    window.loadExpenses = loadExpenses;
    window.loadSavings = loadSavings;

  }); // end DOMContentLoaded
  
  /* ===============================
  REPORTS - CHARTS
================================ */

//Build reports when Reports tab is opened
document.querySelector('[data-tab="reports"]').addEventListener("click", () => {
  setTimeout(buildReportsCharts, 200);
});

// Rebuild charts on year change IF reports tab is active
document.getElementById("filterYear").addEventListener("change", () => {
  if (!document.querySelector('[data-panel="reports"]').classList.contains("hidden")) {
    buildReportsCharts();
  }
});

let monthlyOverviewChart;
let netTrendChart;

async function buildReportsCharts() {

	  const year = Number(document.getElementById("filterYear").value);

	  const labels = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

	  // Initialize arrays
	  const incomeData  = new Array(12).fill(0);
	  const expenseData = new Array(12).fill(0);
	  const savingsData = new Array(12).fill(0);

	  // ---------- FETCH ALL DATA ----------
	 const [incomes, expenses, savings] = await Promise.all([
  fetch("/api/incomes").then(r => r.ok ? r.json() : []),
  fetch("/api/expenses").then(r => r.ok ? r.json() : []),
  fetch(`/api/savings?year=${year}`).then(r => r.ok ? r.json() : [])
]);


	  // ---------- AGGREGATE INCOMES ----------
	  incomes.forEach(i => {
	    const d = new Date(i.date);
	    if (d.getFullYear() === year) {
	      incomeData[d.getMonth()] += Number(i.amount || 0);
	    }
	  });

	  // ---------- AGGREGATE EXPENSES ----------
	  expenses.forEach(e => {
	    const d = new Date(e.date);
	    if (d.getFullYear() === year) {
	      expenseData[d.getMonth()] += Number(e.amount || 0);
	    }
	  });

	  // ---------- AGGREGATE SAVINGS ----------
	  savings.forEach(s => {
	    const d = new Date(s.date);
	    if (d.getFullYear() === year) {
	      savingsData[d.getMonth()] += Number(s.amount || 0);
	    }
	  });

	  // ---------- NET CALCULATION ----------
	  const netData = incomeData.map((val, i) =>
	    val - expenseData[i] - savingsData[i]
	  );

	  /* ================= BAR CHART ================= */
	  const ctx1 = document.getElementById("monthlyOverviewChart");
	  if (monthlyOverviewChart) monthlyOverviewChart.destroy();

	  monthlyOverviewChart = new Chart(ctx1, {
	    type: "bar",
	    data: {
	      labels,
	      datasets: [
	        {
	          label: "Income",
	          data: incomeData,
	          backgroundColor: "#10b981",
	          borderRadius: 6
	        },
	        {
	          label: "Expenses",
	          data: expenseData,
	          backgroundColor: "#ef4444",
	          borderRadius: 6
	        },
	        {
	          label: "Savings",
	          data: savingsData,
	          backgroundColor: "#3b82f6",
	          borderRadius: 6
	        }
	      ]
	    },
	    options: {
	      responsive: true,
	      plugins: {
	        legend: {
	          position: "bottom",
	          labels: { usePointStyle: true }
	        }
	      },
	      scales: {
	        y: {
	          grid: { color: "#eef2f7" },
	          ticks: { callback: v => "‚Çπ" + v }
	        },
	        x: { grid: { display: false } }
	      }
	    }
	  });

	  /* ================= LINE CHART ================= */
	  const ctx2 = document.getElementById("netTrendChart");
	  if (netTrendChart) netTrendChart.destroy();

	  netTrendChart = new Chart(ctx2, {
	    type: "line",
	    data: {
	      labels,
	      datasets: [{
	        label: "Net Amount",
	        data: netData,
	        borderColor: "#2563eb",
	        backgroundColor: "rgba(37,99,235,0.08)",
	        fill: true,
	        tension: 0.35,
	        pointRadius: 4
	      }]
	    },
	    options: {
	      responsive: true,
	      plugins: { legend: { position: "bottom" } },
	      scales: {
	        y: {
	          grid: { color: "#eef2f7" },
	          ticks: { callback: v => "‚Çπ" + v }
	        },
	        x: { grid: { display: false } }
	      }
	    }
	  });
	}
	
function downloadTemplate() {
	  window.location.href = "/api/template/download";
	}

/* ===============================
DOWNLOAD EXCEL HANDLER
================================ */

document.getElementById("downloadExcelBtn").addEventListener("click", () => {
const year = document.getElementById("downloadYear").value;
const month = document.getElementById("downloadMonth").value;

if (!year) {
 alert("Please select year");
 return;
}

let url = `/api/reports/download?year=${year}`;

// Month ALL ante pass cheyyakudadhu
if (month && month !== "ALL") {
 url += `&month=${month}`;
}

window.location.href = url; // üî• Excel download
});

(function populateDownloadYears() {
	  const yearSelect = document.getElementById("downloadYear");
	  const currentYear = new Date().getFullYear();

	  for (let y = currentYear; y >= 2020; y--) {
	    const opt = document.createElement("option");
	    opt.value = y;
	    opt.text = y;
	    yearSelect.appendChild(opt);
	  }

	  yearSelect.value = currentYear; // ‚úÖ auto select
	})();


//Show selected file name
document.getElementById("excelFileInput").addEventListener("change", function () {
  const label = document.getElementById("selectedFileName");
  label.innerText = this.files.length > 0 ? this.files[0].name : "No file chosen";
});

// Upload Excel
document.getElementById("uploadExcelBtn").addEventListener("click", async () => {

  const fileInput = document.getElementById("excelFileInput");
  const msgDiv = document.getElementById("uploadMsg");

  msgDiv.classList.add("hidden");

  if (!fileInput.files || fileInput.files.length === 0) {
    msgDiv.innerText = "‚ùå Please select an Excel file";
    msgDiv.className =
      "mt-3 px-4 py-2 rounded-md text-sm font-medium bg-red-50 text-red-600";
    msgDiv.classList.remove("hidden");
    return;
  }

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  const btn = document.getElementById("uploadExcelBtn");
  btn.disabled = true;
  btn.innerText = "Uploading...";

  try {
    const resp = await fetch("/api/upload", {
      method: "POST",
      body: formData
    });

    if (!resp.ok) throw new Error();

    // ‚úÖ SUCCESS MESSAGE
    msgDiv.innerText = "‚úÖ Excel uploaded successfully";
    msgDiv.className =
      "mt-3 px-4 py-2 rounded-md text-sm font-medium bg-green-50 text-green-700";
    msgDiv.classList.remove("hidden");

    fileInput.value = "";
    document.getElementById("selectedFileName").innerText = "No file chosen";

    if (window.loadIncomes) loadIncomes();
    if (window.loadExpenses) loadExpenses();
    if (window.loadSavings) loadSavings();

  } catch (err) {
    msgDiv.innerText = "‚ùå Upload failed. Please check Excel format.";
    msgDiv.className =
      "mt-3 px-4 py-2 rounded-md text-sm font-medium bg-red-50 text-red-600";
    msgDiv.classList.remove("hidden");
  } finally {
    btn.disabled = false;
    btn.innerText = "Upload Excel";
  }
});

//logged off
document.getElementById("logoutBtn").addEventListener("click", async () => {
  if (!confirm("Are you sure you want to logout?")) return;

  try {
    const resp = await fetch("/auth/logout", { method: "POST" });
    if (resp.ok) {
      window.location.href = "/login"; // MUST exist in static folder
    } else {
      alert("Logout failed");
    }
  } catch (e) {
    alert("Logout error");
  }
});

  
</script>

</body>
</html>
